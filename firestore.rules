rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function episodePath(episodeId) {
      return /databases/$(database)/documents/episodes/$(episodeId);
    }

    function entPath(uid) {
      return /databases/$(database)/documents/entitlements/$(uid);
    }

    // Safe helper: treat missing episode as not published
    function episodeIsPublished(episodeId) {
      return exists(episodePath(episodeId))
        && get(episodePath(episodeId)).data.isPublished == true;
    }

    function episodeIsFreePreview(episodeId) {
      return exists(episodePath(episodeId))
        && get(episodePath(episodeId)).data.isFreePreview == true;
    }

    function hasEntDoc(uid) {
      return exists(entPath(uid));
    }

    function isSubscriber(uid) {
      return hasEntDoc(uid) && get(entPath(uid)).data.isSubscriber == true;
    }

    function hasUnlocked(uid, episodeId) {
      return hasEntDoc(uid)
        && (get(entPath(uid)).data.unlockedEpisodeIds is list)
        && (episodeId in get(entPath(uid)).data.unlockedEpisodeIds);
    }

    // Gate "paid content" reads (scenes) behind entitlement
    function canReadEpisodeContent(episodeId) {
      return signedIn()
        && episodeIsPublished(episodeId)
        && (
          episodeIsFreePreview(episodeId) ||
          isSubscriber(request.auth.uid) ||
          hasUnlocked(request.auth.uid, episodeId)
        );
    }

    // ===== Episodes (public metadata) =====
    match /episodes/{episodeId} {
      // Allow reading published episode metadata (title, description, etc.)
      // (Note: field-level privacy is NOT possible in Firestore rules)
      allow read: if resource != null && resource.data.isPublished == true;
      allow write: if false;

      // Scenes contain actual episode content -> must be gated
      match /scenes/{sceneId} {
        allow read: if canReadEpisodeContent(episodeId);
        allow write: if false;
      }

      // Solutions must never be readable/writable from clients
      match /solutions/{sceneId} {
        allow read, write: if false;
      }
    }

    // ===== Entitlements (private per user) =====
    match /entitlements/{uid} {
      allow read: if isOwner(uid);
      allow write: if false; // only Functions (Admin SDK bypasses rules)
    }

    // ===== Progress (private per user) =====
    match /progress/{uid}/episodes/{episodeId} {
      // Read only if owner AND they are allowed to access that episode content
      allow read: if isOwner(uid) && canReadEpisodeContent(episodeId);
      allow write: if false; // only Functions
    }

    // ===== Default deny =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
